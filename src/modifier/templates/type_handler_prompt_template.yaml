# Type Handler 생성을 위한 프롬프트 템플릿
# MyBatis TypeHandler를 통한 암복호화 적용

# Type Handler 클래스 생성 템플릿
type_handler_class:
  system_instruction: |
    You are an expert Java developer specializing in MyBatis framework.
    Your task is to generate a TypeHandler class that handles encryption and decryption of sensitive data.
    
  requirements: |
    1. Extend org.apache.ibatis.type.BaseTypeHandler<String>
    2. Implement all required methods:
       - setNonNullParameter: Encrypt data before INSERT/UPDATE
       - getNullableResult (3 overloads): Decrypt data after SELECT
    3. Use the CryptoService class for encryption/decryption
    4. Handle null values properly
    5. Add proper error handling and logging
    
  crypto_service_usage: |
    Import: import com.ksign.crypto.CryptoService;
    
    Encryption: 
      String encrypted = CryptoService.encrypt(plainText);
    
    Decryption:
      String decrypted = CryptoService.decrypt(encryptedText);
      
  example_code: |
    package com.example.typehandler;
    
    import java.sql.CallableStatement;
    import java.sql.PreparedStatement;
    import java.sql.ResultSet;
    import java.sql.SQLException;
    
    import org.apache.ibatis.type.BaseTypeHandler;
    import org.apache.ibatis.type.JdbcType;
    import org.apache.ibatis.type.MappedTypes;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    
    import com.ksign.crypto.CryptoService;
    
    @MappedTypes(String.class)
    public class EncryptedStringTypeHandler extends BaseTypeHandler<String> {
        
        private static final Logger logger = LoggerFactory.getLogger(EncryptedStringTypeHandler.class);
        
        @Override
        public void setNonNullParameter(PreparedStatement ps, int i, 
                String parameter, JdbcType jdbcType) throws SQLException {
            try {
                String encrypted = CryptoService.encrypt(parameter);
                ps.setString(i, encrypted);
            } catch (Exception e) {
                logger.error("Encryption failed", e);
                throw new SQLException("Encryption failed", e);
            }
        }
        
        @Override
        public String getNullableResult(ResultSet rs, String columnName) throws SQLException {
            String encrypted = rs.getString(columnName);
            return decrypt(encrypted);
        }
        
        @Override
        public String getNullableResult(ResultSet rs, int columnIndex) throws SQLException {
            String encrypted = rs.getString(columnIndex);
            return decrypt(encrypted);
        }
        
        @Override
        public String getNullableResult(CallableStatement cs, int columnIndex) throws SQLException {
            String encrypted = cs.getString(columnIndex);
            return decrypt(encrypted);
        }
        
        private String decrypt(String encrypted) throws SQLException {
            if (encrypted == null) {
                return null;
            }
            try {
                return CryptoService.decrypt(encrypted);
            } catch (Exception e) {
                logger.error("Decryption failed", e);
                throw new SQLException("Decryption failed", e);
            }
        }
    }

# XML Mapper 수정 템플릿
xml_mapper_modification:
  system_instruction: |
    You are an expert in MyBatis XML mapper configuration.
    Your task is to modify XML mapper files to use TypeHandler for automatic encryption/decryption.
    
  modification_rules: |
    1. For <resultMap> elements:
       - Add typeHandler attribute to <result> tags that map to encrypted columns
       - Example: <result column="sensitive_data" property="sensitiveData" 
                         typeHandler="com.example.typehandler.EncryptedStringTypeHandler"/>
    
    2. For INSERT/UPDATE statements:
       - Modify #{paramName} to #{paramName,typeHandler=com.example.typehandler.EncryptedStringTypeHandler}
       - Only for parameters that map to encrypted columns
    
    3. Do NOT modify:
       - Columns not in the target list
       - SELECT statements (handled by resultMap)
       - Any other XML structure
    
  example_before: |
    <resultMap id="employeeMap" type="Employee">
        <id column="emp_id" property="empId"/>
        <result column="name" property="name"/>
        <result column="jumin_number" property="juminNumber"/>
        <result column="phone" property="phone"/>
    </resultMap>
    
    <insert id="insertEmployee">
        INSERT INTO employee (name, jumin_number, phone)
        VALUES (#{name}, #{juminNumber}, #{phone})
    </insert>
    
  example_after: |
    <resultMap id="employeeMap" type="Employee">
        <id column="emp_id" property="empId"/>
        <result column="name" property="name"/>
        <result column="jumin_number" property="juminNumber" 
                typeHandler="com.example.typehandler.EncryptedStringTypeHandler"/>
        <result column="phone" property="phone" 
                typeHandler="com.example.typehandler.EncryptedStringTypeHandler"/>
    </resultMap>
    
    <insert id="insertEmployee">
        INSERT INTO employee (name, jumin_number, phone)
        VALUES (#{name}, 
                #{juminNumber,typeHandler=com.example.typehandler.EncryptedStringTypeHandler}, 
                #{phone,typeHandler=com.example.typehandler.EncryptedStringTypeHandler})
    </insert>

