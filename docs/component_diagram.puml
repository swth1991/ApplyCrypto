@startuml component_diagram
!theme plain
skinparam componentStyle rectangle
skinparam linetype ortho
skinparam maxMessageSize 30
skinparam wrapWidth 100
skinparam packageStyle rectangle
skinparam nodesep 10
skinparam ranksep 20

title ApplyCrypto Component Diagram

package "CLI Layer" {
  component [CLIController] as CLI
}

package "Configuration" {
  component [ConfigManager] as Config
}

package "Collection" {
  component [SourceFileCollector] as Collector
}

package "Parsing" {
  component [JavaASTParser] as JavaParser
  component [XMLMapperParser] as XMLParser
  component [CallGraphBuilder] as CallGraph
  component [EndpointStrategy] as EndpointStrategy
  component [EndpointStrategyFactory] as EndpointStrategyFactory
  component [SpringMVCExtraction] as SpringMVC
  component [AnyframeExtraction] as AnyframeEndpoint
}

package "Analysis" {
  component [DBAccessAnalyzer] as DBAnalyzer
  component [SQLExtractor] as SQLExtractor
  component [MyBatisExtractor] as MyBatisExtractor
  component [JDBCExtractor] as JDBCExtractor
  component [JPAExtractor] as JPAExtractor
  component [AnyframeExtractor] as AnyframeExtractor
  component [SQLExtractorFactory] as SQLExtractorFactory
}

package "Modification" {
  component [CodeModifier] as CodeModifier
  component [CodeGenerator] as CodeGenerator
  component [ControllerServiceGen] as ControllerServiceGen
  component [ServiceImplBizGen] as ServiceImplBizGen
  component [TypeHandlerGen] as TypeHandlerGen
  component [CodeGenFactory] as CodeGenFactory
  component [ContextGenerator] as ContextGen
  component [ContextGenFactory] as ContextGenFactory
  component [JDBCContextGen] as JdbcContextGen
  component [MyBatisContextGen] as MybatisContextGen
  component [BatchProcessor] as BatchProcessor
  component [CodePatcher] as CodePatcher
  component [ErrorHandler] as ErrorHandler
  component [ResultTracker] as ResultTracker
  component [CallChainProcessor] as CallChainProcessor
}

package "Generator" {
  component [TypeHandlerGenerator] as TypeHandlerGenerator
}

package "LLM" {
  component [LLMFactory] as LLMFactory
  component [LLMProvider] as LLMProvider
  component [WatsonX] as WatsonX
  component [WatsonXOnPrem] as WatsonXOnPrem
  component [OpenAI] as OpenAI
  component [ClaudeAI] as Claude
  component [MockLLM] as MockLLM
}

package "Storage" {
  component [DataPersistenceManager] as Persistence
  component [CacheManager] as Cache
}

package "Models" {
  component [SourceFile] as SourceFileModel
  component [TableAccessInfo] as TableAccessModel
  component [Method] as MethodModel
  component [CallRelation] as CallRelationModel
  component [ModificationRecord] as ModRecordModel
  component [Endpoint] as EndpointModel
  component [ModificationContext] as ModContextModel
  component [ModificationPlan] as ModPlanModel
}

' CLI Layer relationships
CLI --> Config
CLI --> Collector
CLI --> JavaParser
CLI --> XMLParser
CLI --> CallGraph
CLI --> DBAnalyzer
CLI --> CodeModifier
CLI --> CallChainProcessor
CLI --> TypeHandlerGenerator
CLI --> Persistence
CLI --> EndpointStrategyFactory

' Collection Layer relationships
Collector --> Config
Collector --> JavaParser
Collector ..> SourceFileModel : creates

' Parsing Layer relationships
JavaParser --> Cache
JavaParser ..> MethodModel : creates
JavaParser ..> CallRelationModel : creates
XMLParser --> JavaParser
XMLParser ..> TableAccessModel : creates
CallGraph --> JavaParser
CallGraph --> Cache
CallGraph --> MethodModel
CallGraph --> CallRelationModel
CallGraph --> EndpointStrategy
CallGraph ..> EndpointModel : creates
EndpointStrategyFactory --> EndpointStrategy
EndpointStrategyFactory --> SpringMVC
EndpointStrategyFactory --> AnyframeEndpoint
EndpointStrategy <|-- SpringMVC
EndpointStrategy <|-- AnyframeEndpoint

' Analysis Layer relationships
DBAnalyzer --> Config
DBAnalyzer --> XMLParser
DBAnalyzer --> JavaParser
DBAnalyzer --> CallGraph
DBAnalyzer --> SQLExtractor
DBAnalyzer ..> TableAccessModel : creates
SQLExtractor <|-- MyBatisExtractor
SQLExtractor <|-- JDBCExtractor
SQLExtractor <|-- JPAExtractor
SQLExtractor <|-- AnyframeExtractor
SQLExtractorFactory --> Config
SQLExtractorFactory --> SQLExtractor
SQLExtractorFactory --> MyBatisExtractor
SQLExtractorFactory --> JDBCExtractor
SQLExtractorFactory --> JPAExtractor
SQLExtractorFactory --> AnyframeExtractor

' Modification Layer relationships
CodeModifier --> Config
CodeModifier --> CodeGenerator
CodeModifier --> CodePatcher
CodeModifier --> ErrorHandler
CodeModifier --> ResultTracker
CodeModifier --> TableAccessModel
CodeModifier --> LLMProvider
CodeGenerator <|-- ControllerServiceGen
CodeGenerator <|-- ServiceImplBizGen
CodeGenerator <|-- TypeHandlerGen
CodeGenFactory --> Config
CodeGenFactory --> CodeGenerator
CodeGenFactory --> ControllerServiceGen
CodeGenFactory --> ServiceImplBizGen
CodeGenFactory --> TypeHandlerGen
CodeGenFactory --> LLMProvider
ControllerServiceGen --> ContextGen
ControllerServiceGen --> BatchProcessor
ControllerServiceGen --> LLMProvider
ServiceImplBizGen --> ContextGen
TypeHandlerGen --> ContextGen
ContextGenFactory --> Config
ContextGenFactory --> ContextGen
ContextGenFactory --> JdbcContextGen
ContextGenFactory --> MybatisContextGen
ContextGen <|-- JdbcContextGen
ContextGen <|-- MybatisContextGen
BatchProcessor --> LLMProvider
CodePatcher --> ErrorHandler
ResultTracker ..> ModRecordModel : creates
CallChainProcessor --> Config
CallChainProcessor --> CodeGenerator
CallChainProcessor --> CodePatcher
CallChainProcessor --> LLMProvider

' Generator Layer relationships
TypeHandlerGenerator --> Config

' LLM Layer relationships
LLMFactory --> LLMProvider
LLMFactory --> WatsonX
LLMFactory --> WatsonXOnPrem
LLMFactory --> OpenAI
LLMFactory --> Claude
LLMFactory --> MockLLM
WatsonX ..|> LLMProvider
WatsonXOnPrem ..|> LLMProvider
OpenAI ..|> LLMProvider
Claude ..|> LLMProvider
MockLLM ..|> LLMProvider

' Storage Layer relationships
Persistence --> Cache
Persistence ..> SourceFileModel : serializes
Persistence ..> TableAccessModel : serializes
Persistence ..> MethodModel : serializes
Persistence ..> CallRelationModel : serializes
Persistence ..> ModRecordModel : serializes
Persistence ..> EndpointModel : serializes

note right of CLI
  CLI Entry Point
  analyze, list, modify, clear
end note

note right of CodeModifier
  LLM-based
  Automatic Code Modification
end note

note right of DBAnalyzer
  DB Access Pattern Analysis
  Call Graph Reverse Tracking
end note

note right of SQLExtractor
  SQL Extraction Strategy
  MyBatis, JDBC, JPA, Anyframe
end note

note right of EndpointStrategy
  Endpoint Extraction
  Spring MVC, Anyframe
end note

note right of CallChainProcessor
  Call Chain Mode
  Process by Call Chain
end note

note right of TypeHandlerGenerator
  Type Handler Mode
  MyBatis TypeHandler Generation
end note

@enduml
